<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>–°–ø–∏—Å–æ–∫ —Å–ø–µ–∫—Ç–∞–∫–ª–µ–π</title>
    <!-- Bootstrap 5 CSS –∏–∑ CDN -->
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
    />
</head>
<body>

<div class="container my-5">
    <h1 class="mb-4">üé≠ –°–ø–∏—Å–æ–∫ —Å–ø–µ–∫—Ç–∞–∫–ª–µ–π</h1>

    <!-- –§–∏–ª—å—Ç—Ä –ø–æ –∂–∞–Ω—Ä–∞–º -->
    <div class="mb-3 row align-items-center">
        <label for="genreFilter" class="col-sm-2 col-form-label fw-bold">
            –§–∏–ª—å—Ç—Ä –ø–æ –∂–∞–Ω—Ä—É:
        </label>
        <div class="col-sm-4">
            <select id="genreFilter" class="form-select">
                <option value="">–í—Å–µ –∂–∞–Ω—Ä—ã</option>
            </select>
        </div>
        <div class="col-sm-6 text-end">
            <button id="refreshBtn" class="btn btn-outline-primary">
                –û–±–Ω–æ–≤–∏—Ç—å
            </button>
        </div>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ —Å–æ —Å–ø–µ–∫—Ç–∞–∫–ª—è–º–∏ -->
    <div class="table-responsive">
        <table class="table table-hover table-bordered align-middle">
            <thead class="table-dark">
            <tr>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                <th>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω)</th>
                <th>–ñ–∞–Ω—Ä</th>
            </tr>
            </thead>
            <tbody id="performanceTableBody">
            <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç —Å—Ç—Ä–æ–∫–∏ —Å —Å–ø–µ–∫—Ç–∞–∫–ª—è–º–∏ -->
            </tbody>
        </table>
    </div>
</div>

<script>
    // –•—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–¥–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    let genres = [];
    let performances = [];

    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∂–∞–Ω—Ä–æ–≤
    async function fetchGenres() {
        try {
            const res = await fetch('/performances/genres');
            genres = await res.json();
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∂–∞–Ω—Ä–æ–≤:', err);
            genres = [];
        }
        const genreFilter = document.getElementById('genreFilter');
        genreFilter.innerHTML = '<option value="">–í—Å–µ –∂–∞–Ω—Ä—ã</option>';
        genres.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g.genreId;
            opt.textContent = g.genreName;
            genreFilter.appendChild(opt);
        });
    }

    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–ø–µ–∫—Ç–∞–∫–ª–µ–π
    async function fetchPerformances() {
        try {
            const res = await fetch('/performances');
            performances = await res.json();
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–µ–∫—Ç–∞–∫–ª–µ–π:', err);
            performances = [];
        }
        renderPerformances();
    }

    // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É, —Ñ–∏–ª—å—Ç—Ä—É—è –ø–æ –∂–∞–Ω—Ä—É, –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω
    function renderPerformances() {
        const tbody = document.getElementById('performanceTableBody');
        const selectedGenre = document.getElementById('genreFilter').value;
        tbody.innerHTML = '';

        const filtered = selectedGenre
            ? performances.filter(p => String(p.genreId) === selectedGenre)
            : performances;

        if (filtered.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center text-muted">
                        –°–ø–µ–∫—Ç–∞–∫–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.
                    </td>
                </tr>`;
            return;
        }

        filtered.forEach(p => {
            // –ò—â–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∂–∞–Ω—Ä–∞ –ø–æ p.genreId
            const genreName = (genres.find(g => g.genreId === p.genreId) || {}).genreName || '‚Äî';
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${p.title}</td>
                <td>${p.description}</td>
                <td>${p.duration}</td>
                <td>${genreName}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    document.getElementById('genreFilter').addEventListener('change', renderPerformances);
    document.getElementById('refreshBtn').addEventListener('click', () => {
        fetchGenres();
        fetchPerformances();
    });

    // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–¥–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    (async () => {
        await fetchGenres();
        await fetchPerformances();
    })();
</script>

<!-- Bootstrap 5 JS Bundle –∏–∑ CDN -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
