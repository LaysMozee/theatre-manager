<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>–°–ø–∏—Å–æ–∫ —Å–ø–µ–∫—Ç–∞–∫–ª–µ–π</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
          background-image: url('/uploads/photos/retro-sceny-vsemirnogo-dna-teatra-s-zanaveskami-i-scenoi.jpg');
          background-size: cover;
          background-repeat: no-repeat;
          background-attachment: fixed;
          color: #ffffff;
        }
        h1 {
          color: #ffffff; /* –ë–µ–ª—ã–π —Ü–≤–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
          text-shadow: 1px 1px 3px #000;
          font-size: 2.5rem;
        }
        label {
          color: #ffffff;
          text-shadow: 1px 1px 2px #000;
          font-size: 1.1rem;
        }

        .form-select option {
          color: black;
        }

        .table-custom {
          background-color: rgba(0, 0, 0, 0.6);
          color: #fff;
          border-collapse: separate;
          border-spacing: 0;
          border-radius: 10px;
          overflow: hidden;
        }
        .table-custom th,
        .table-custom td {
          font-size: 1.1rem; /* –ù–µ–º–Ω–æ–≥–æ —É–º–µ–Ω—å—à–∏–ª —à—Ä–∏—Ñ—Ç */
          padding: 0.5rem 0.75rem; /* –£–º–µ–Ω—å—à–∏–ª –æ—Ç—Å—Ç—É–ø—ã */
        }

        .table-hover tbody tr:hover td {
          background-color: #444444;
          color: #fff;
        }

        .btn-primary {
          background-color: #0066cc;
          border-color: #005bb5;
        }

        .btn-danger {
          background-color: #cc0000;
          border-color: #b30000;
        }

        .btn-outline-primary {
          color: #ffffff;
          border-color: #ffffff;
        }

        .btn-outline-primary:hover {
          background-color: #ffffff;
          color: #000;
        }

    </style>
</head>
<body>
<div th:replace="~{navbar.html}"></div>
<div class="container my-5">
    <h1 class="mb-4 text-white">üé≠ –°–ø–∏—Å–æ–∫ —Å–ø–µ–∫—Ç–∞–∫–ª–µ–π</h1>
    <div class="mb-4 row align-items-center">
        <label for="genreFilter" class="col-sm-2 col-form-label fw-bold">
            –§–∏–ª—å—Ç—Ä –ø–æ –∂–∞–Ω—Ä—É:
        </label>
        <div class="col-sm-4">
            <select id="genreFilter" class="form-select">
                <option value="">–í—Å–µ –∂–∞–Ω—Ä—ã</option>
            </select>
        </div>
        <div class="col-sm-6 text-end">
            <button id="refreshBtn" class="btn btn-outline-light me-2">–û–±–Ω–æ–≤–∏—Ç—å</button>
            <a th:if="${canAdd}" href="/performances/add" class="btn btn-warning">–î–æ–±–∞–≤–∏—Ç—å —Å–ø–µ–∫—Ç–∞–∫–ª—å</a>
        </div>
    </div>

    <div class="table-responsive rounded">
        <table class="table table-hover table-bordered table-custom align-middle">
            <thead>
            <tr>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                <th>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω)</th>
                <th>–ñ–∞–Ω—Ä</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
            </thead>
            <tbody id="performanceTableBody">
            <!-- –°—Ç—Ä–æ–∫–∏ –±—É–¥—É—Ç —Ç—É—Ç -->
            </tbody>
        </table>
    </div>
</div>

<script th:inline="javascript">
    let userRole = /*[[${userRole != null} ? '${userRole}' : 'user']]*/ 'user';
    userRole = userRole.toLowerCase();
    let genres = [];
    let performances = [];

    async function fetchGenres() {
      try {
        const response = await fetch('/performances/genres');
        genres = await response.json();
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∂–∞–Ω—Ä–æ–≤:', error);
        genres = [];
      }

      const genreFilter = document.getElementById('genreFilter');
      genreFilter.innerHTML = '<option value="">–í—Å–µ –∂–∞–Ω—Ä—ã</option>';
      genres.forEach(genre => {
        const option = document.createElement('option');
        option.value = genre.genreId;
        option.textContent = genre.genreName;
        genreFilter.appendChild(option);
      });
    }

    async function fetchPerformances() {
      try {
        const response = await fetch('/performances');
        performances = await response.json();
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–µ–∫—Ç–∞–∫–ª–µ–π:', error);
        performances = [];
      }
      renderPerformances();
    }

    function renderPerformances() {
      const tbody = document.getElementById('performanceTableBody');
      const selectedGenre = document.getElementById('genreFilter').value;
      tbody.innerHTML = '';

      let filtered = performances;
      if (selectedGenre) {
        filtered = performances.filter(p => String(p.genreId) === selectedGenre);
      }

      if (filtered.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="text-center text-muted">–°–ø–µ–∫—Ç–∞–∫–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</td>
          </tr>`;
        return;
      }

      filtered.forEach(p => {
        const genreName = (genres.find(g => g.genreId === p.genreId) || {}).genreName || '‚Äî';
        const actionButtons = `
          <td>
            <button class="btn btn-sm btn-primary me-1" onclick="editPerformance(${p.performanceId})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button class="btn btn-sm btn-danger" onclick="deletePerformance(${p.performanceId})">–£–¥–∞–ª–∏—Ç—å</button>
          </td>`;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(p.title)}</td>
          <td>${escapeHtml(p.description)}</td>
          <td>${p.duration}</td>
          <td>${escapeHtml(genreName)}</td>
          ${actionButtons}
        `;
        tbody.appendChild(tr);
      });
    }

    function escapeHtml(text) {
      if (!text) return '';
      return text.replace(/[&<>"']/g, function(m) {
        return {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        }[m];
      });
    }

    function deletePerformance(id) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–ø–µ–∫—Ç–∞–∫–ª—å —Å ID: ' + id + '?')) return;
      fetch('/performances/delete/' + id, { method: 'DELETE' })
        .then(res => {
          if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ HTTP: ' + res.status);
          return res.json();
        })
        .then(data => {
          if (data.status === 'success') {
            alert('–°–ø–µ–∫—Ç–∞–∫–ª—å —É–¥–∞–ª—ë–Ω');
            fetchPerformances();
          } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + (data.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
          }
        })
        .catch(err => alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message));
    }

    function editPerformance(id) {
      window.location.href = `/performances/edit/${id}`;
    }

    document.getElementById('genreFilter').addEventListener('change', renderPerformances);
    document.getElementById('refreshBtn').addEventListener('click', async () => {
      await fetchGenres();
      await fetchPerformances();
    });

    (async () => {
      await fetchGenres();
      await fetchPerformances();
    })();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>