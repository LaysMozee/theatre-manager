<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>–°–ø–∏—Å–æ–∫ —Å–ø–µ–∫—Ç–∞–∫–ª–µ–π</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<style>   body {
background-image: url('/uploads/photos/retro-sceny-vsemirnogo-dna-teatra-s-zanaveskami-i-scenoi.jpg');
background-size: cover;
background-repeat: no-repeat;
background-attachment: fixed;
}
  .form-select option {
    color: black;
  }

  .table-hover tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.05);
  }
</style>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="#" th:text="'–¢–µ–∞—Ç—Ä ‚Äî ' + ${username}">–¢–µ–∞—Ç—Ä</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/workers}">
                        <i class="fas fa-users"></i> –ù–∞—à–∏ –∞–∫—Ç—ë—Ä—ã
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/requisites}">
                        <i class="fas fa-mask"></i> –†–µ–∫–≤–∏–∑–∏—Ç
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/rehearsals}">
                        <i class="fas fa-calendar-alt"></i> –†–µ–ø–µ—Ç–∏—Ü–∏–∏
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{performances/view}">
                        <i class="fas fa-theater-masks"></i> –°–ø–µ–∫—Ç–∞–∫–ª–∏
                    </a>
                </li>
            </ul>
            <a class="btn btn-outline-danger" th:href="@{/logout}">
                <i class="fas fa-sign-out-alt me-1"></i> –í—ã—Ö–æ–¥
            </a>
        </div>
    </div>
</nav>
<div class="container my-5">
    <h1 class="mb-4">üé≠ –°–ø–∏—Å–æ–∫ —Å–ø–µ–∫—Ç–∞–∫–ª–µ–π</h1>
    <div class="mb-3 row align-items-center">
        <label for="genreFilter" class="col-sm-2 col-form-label fw-bold">
            –§–∏–ª—å—Ç—Ä –ø–æ –∂–∞–Ω—Ä—É:
        </label>
        <div class="col-sm-4">
            <select id="genreFilter" class="form-select">
                <option value="">–í—Å–µ –∂–∞–Ω—Ä—ã</option>
            </select>
        </div>
        <div class="col-sm-6 text-end">
            <button id="refreshBtn" class="btn btn-outline-primary me-2">–û–±–Ω–æ–≤–∏—Ç—å</button>
            <a th:if="${canAdd}" href="/performances/add" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å —Å–ø–µ–∫—Ç–∞–∫–ª—å</a>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover table-bordered align-middle">
            <thead class="table-dark">
            <tr>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                <th>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω)</th>
                <th>–ñ–∞–Ω—Ä</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
            </thead>
            <tbody id="performanceTableBody">
            <!-- –°—Ç—Ä–æ–∫–∏ –±—É–¥—É—Ç —Ç—É—Ç -->
            </tbody>
        </table>
    </div>
</div>


    <script th:inline="javascript">
     // –ü–æ–ª—É—á–∞–µ–º —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Thymeleaf –∏–ª–∏ —Å—Ç–∞–≤–∏–º user –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
     let userRole = /*[[${userRole != null} ? '${userRole}' : 'user']]*/ 'user';
     userRole = userRole.toLowerCase();

     let genres = [];
     let performances = [];

     // –ó–∞–≥—Ä—É–∑–∫–∞ –∂–∞–Ω—Ä–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞
     async function fetchGenres() {
       try {
         const response = await fetch('/performances/genres');
         genres = await response.json();
       } catch (error) {
         console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∂–∞–Ω—Ä–æ–≤:', error);
         genres = [];
       }

       const genreFilter = document.getElementById('genreFilter');
       genreFilter.innerHTML = '<option value="">–í—Å–µ –∂–∞–Ω—Ä—ã</option>';
       genres.forEach(genre => {
         const option = document.createElement('option');
         option.value = genre.genreId;
         option.textContent = genre.genreName;
         genreFilter.appendChild(option);
       });
     }

     // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–µ–∫—Ç–∞–∫–ª–µ–π —Å —Å–µ—Ä–≤–µ—Ä–∞
     async function fetchPerformances() {
       try {
         const response = await fetch('/performances');
         performances = await response.json();
       } catch (error) {
         console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–µ–∫—Ç–∞–∫–ª–µ–π:', error);
         performances = [];
       }
       renderPerformances();
     }

     // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç–∞–±–ª–∏—Ü—ã —Å–ø–µ–∫—Ç–∞–∫–ª–µ–π —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –∂–∞–Ω—Ä—É
     function renderPerformances() {
  const tbody = document.getElementById('performanceTableBody');
  const selectedGenre = document.getElementById('genreFilter').value;
  tbody.innerHTML = '';

  let filtered = performances;
  if (selectedGenre) {
    filtered = performances.filter(p => String(p.genreId) === selectedGenre);
  }

  if (filtered.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="5" class="text-center text-muted">–°–ø–µ–∫—Ç–∞–∫–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</td>
      </tr>`;
    return;
  }

  filtered.forEach(p => {
    const genreName = (genres.find(g => g.genreId === p.genreId) || {}).genreName || '‚Äî';

    // –£–±–∏—Ä–∞–µ–º —É—Å–ª–æ–≤–∏–µ, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∏ –≤—Å–µ–≥–¥–∞ –±—ã–ª–∏ –≤–∏–¥–Ω—ã
    const actionButtons = `
      <td>
        <button class="btn btn-sm btn-primary me-1" onclick="editPerformance(${p.performanceId})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <button class="btn btn-sm btn-danger" onclick="deletePerformance(${p.performanceId})">–£–¥–∞–ª–∏—Ç—å</button>
      </td>`;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(p.title)}</td>
      <td>${escapeHtml(p.description)}</td>
      <td>${p.duration}</td>
      <td>${escapeHtml(genreName)}</td>
      ${actionButtons}
    `;
    tbody.appendChild(tr);
  });
}


     // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML (–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
     function escapeHtml(text) {
       if (!text) return '';
       return text.replace(/[&<>"']/g, function(m) {
         return {
           '&': '&amp;',
           '<': '&lt;',
           '>': '&gt;',
           '"': '&quot;',
           "'": '&#39;'
         }[m];
       });
     }

     // –£–¥–∞–ª–µ–Ω–∏–µ —Å–ø–µ–∫—Ç–∞–∫–ª—è —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º
function deletePerformance(id) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–ø–µ–∫—Ç–∞–∫–ª—å —Å ID: ' + id + '?')) return;

  fetch('/performances/delete/' + id, {
    method: 'DELETE',
  })
    .then(res => {
      if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ HTTP: ' + res.status);
      return res.json();
    })
    .then(data => {
      if (data.status === 'success') {
        alert('–°–ø–µ–∫—Ç–∞–∫–ª—å —É–¥–∞–ª—ë–Ω');
        fetchPerformances();
      } else {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + (data.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
      }
    })
    .catch(err => alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message));
}


     // –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø–µ–∫—Ç–∞–∫–ª—è
     function editPerformance(id) {
       window.location.href = `/performances/edit/${id}`;
     }

     // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
     document.getElementById('genreFilter').addEventListener('change', renderPerformances);
     document.getElementById('refreshBtn').addEventListener('click', async () => {
       await fetchGenres();
       await fetchPerformances();
     });

     // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
     (async () => {
       await fetchGenres();
       await fetchPerformances();
     })();
</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
