<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø–µ–∫—Ç–∞–∫–ª—è–º–∏</title>
    <!-- Bootstrap 5 CSS –∏–∑ CDN -->
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
    />
</head>
<body>

<div class="container my-5">
    <h1 class="mb-4">üé≠ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø–µ–∫—Ç–∞–∫–ª—è–º–∏</h1>

    <!-- === –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Å–ø–µ–∫—Ç–∞–∫–ª—è === -->
    <div class="card mb-5 shadow-sm">
        <div class="card-header bg-primary text-white">
            –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å–ø–µ–∫—Ç–∞–∫–ª—å
        </div>
        <div class="card-body">
            <form id="createPerformanceForm" class="row g-3">
                <div class="col-md-6">
                    <label for="newTitle" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" class="form-control" id="newTitle" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ" required>
                </div>
                <div class="col-md-6">
                    <label for="newDuration" class="form-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω—É—Ç—ã)</label>
                    <input type="number" class="form-control" id="newDuration" min="1" placeholder="120" required>
                </div>
                <div class="col-md-6">
                    <label for="newGenre" class="form-label">–ñ–∞–Ω—Ä</label>
                    <select id="newGenre" class="form-select" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∂–∞–Ω—Ä</option>
                        <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –∏–∑ JS -->
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="newDescription" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <input type="text" class="form-control" id="newDescription" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ" required>
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-success">–î–æ–±–∞–≤–∏—Ç—å —Å–ø–µ–∫—Ç–∞–∫–ª—å</button>
                </div>
            </form>
            <div id="createResult" class="mt-3"></div>
        </div>
    </div>
    <!-- ============================================== -->

    <!-- === –§–∏–ª—å—Ç—Ä –ø–æ –∂–∞–Ω—Ä–∞–º === -->
    <div class="mb-3 row align-items-center">
        <label for="genreFilter" class="col-sm-2 col-form-label fw-bold">–§–∏–ª—å—Ç—Ä –ø–æ –∂–∞–Ω—Ä—É:</label>
        <div class="col-sm-4">
            <select id="genreFilter" class="form-select">
                <option value="">–í—Å–µ –∂–∞–Ω—Ä—ã</option>
                <!-- –û–ø—Ü–∏–∏ –∑–∞–ø–æ–ª–Ω—è—Ç—Å—è –∏–∑ JS -->
            </select>
        </div>
        <div class="col-sm-6 text-end">
            <button id="refreshBtn" class="btn btn-outline-primary">–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        </div>
    </div>
    <!-- ======================= -->

    <!-- === –¢–∞–±–ª–∏—Ü–∞ —Å–æ —Å–ø–∏—Å–∫–æ–º —Å–ø–µ–∫—Ç–∞–∫–ª–µ–π === -->
    <div class="table-responsive">
        <table class="table table-hover table-bordered align-middle">
            <thead class="table-dark">
            <tr>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                <th>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω)</th>
                <th>–ñ–∞–Ω—Ä</th>
            </tr>
            </thead>
            <tbody id="performanceTableBody">
            <!-- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è JS -->
            </tbody>
        </table>
    </div>
    <!-- =================================== -->
</div>

<script>
    let genres = [];
    let performances = [];

    // –§—É–Ω–∫—Ü–∏—è: –∑–∞–≥—Ä—É–∂–∞–µ–º –∂–∞–Ω—Ä—ã –∏–∑ API, –∑–∞–ø–æ–ª–Ω—è–µ–º –æ–±–∞ —Å–µ–ª–µ–∫—Ç–∞ (—Ñ–∏–ª—å—Ç—Ä –∏ —Ñ–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è)
    async function fetchGenres() {
        try {
            const res = await fetch('/performances/genres');
            genres = await res.json();
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∂–∞–Ω—Ä–æ–≤:', err);
            genres = [];
        }

        // –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Å–µ–ª–µ–∫—Ç —Ñ–∏–ª—å—Ç—Ä–∞
        const genreFilter = document.getElementById('genreFilter');
        genreFilter.innerHTML = '<option value="">–í—Å–µ –∂–∞–Ω—Ä—ã</option>';
        genres.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g.genreId;
            opt.textContent = g.genreName;
            genreFilter.appendChild(opt);
        });

        // –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Å–µ–ª–µ–∫—Ç –≤ —Ñ–æ—Ä–º–µ —Å–æ–∑–¥–∞–Ω–∏—è
        const newGenreSelect = document.getElementById('newGenre');
        newGenreSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∂–∞–Ω—Ä</option>';
        genres.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g.genreId;
            opt.textContent = g.genreName;
            newGenreSelect.appendChild(opt);
        });
    }

    // –§—É–Ω–∫—Ü–∏—è: –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–ø–µ–∫—Ç–∞–∫–ª–µ–π, –∞ –∑–∞—Ç–µ–º —Ä–µ–Ω–¥–µ—Ä–∏–º —Ç–∞–±–ª–∏—Ü—É
    async function fetchPerformances() {
        try {
            const res = await fetch('/performances');
            performances = await res.json();
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–µ–∫—Ç–∞–∫–ª–µ–π:', err);
            performances = [];
        }
        renderPerformances();
    }

    // –§—É–Ω–∫—Ü–∏—è: –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É —Å —É—á—ë—Ç–æ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞
    function renderPerformances() {
        const tbody = document.getElementById('performanceTableBody');
        const selectedGenre = document.getElementById('genreFilter').value;
        tbody.innerHTML = '';

        const filtered = selectedGenre
            ? performances.filter(p => String(p.genreId) === selectedGenre)
            : performances;

        if (filtered.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center text-muted">
                        –°–ø–µ–∫—Ç–∞–∫–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.
                    </td>
                </tr>`;
            return;
        }

        filtered.forEach(p => {
            const genreName = (genres.find(g => g.genreId === p.genreId) || {}).genreName || '‚Äî';
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${p.title}</td>
                <td>${p.description}</td>
                <td>${p.duration}</td>
                <td>${genreName}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫: –ø—Ä–∏ —Å–º–µ–Ω–µ —Ñ–∏–ª—å—Ç—Ä–∞ ‚Äî –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É
    document.getElementById('genreFilter').addEventListener('change', renderPerformances);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫: –∫–Ω–æ–ø–∫–∞ ¬´–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ¬ª ‚Äî –∑–∞–Ω–æ–≤–æ –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –∏ –∂–∞–Ω—Ä—ã, –∏ —Å–ø–µ–∫—Ç–∞–∫–ª–∏
    document.getElementById('refreshBtn').addEventListener('click', async () => {
        await fetchGenres();
        await fetchPerformances();
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫: –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è —Å–ø–µ–∫—Ç–∞–∫–ª—è
    document.getElementById('createPerformanceForm').addEventListener('submit', async e => {
        e.preventDefault();

        // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–æ–ª–µ–π
        const dto = {
            title: document.getElementById('newTitle').value.trim(),
            description: document.getElementById('newDescription').value.trim(),
            duration: parseInt(document.getElementById('newDuration').value, 10),
            genreId: parseInt(document.getElementById('newGenre').value, 10)
        };

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
        if (!dto.title || !dto.description || !dto.duration || !dto.genreId) {
            document.getElementById('createResult').textContent = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã.';
            return;
        }

        try {
            const res = await fetch('/performances/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dto)
            });

            if (!res.ok) {
                const text = await res.text();
                throw new Error(text || '–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É');
            }

            const newId = await res.json();
            document.getElementById('createResult').innerHTML = `
                <div class="alert alert-success">
                    –°–ø–µ–∫—Ç–∞–∫–ª—å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω (ID = ${newId}). –¢–∞–±–ª–∏—Ü–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è...
                </div>`;

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫: –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –∞—Ñ–∏—à—É –∑–∞–Ω–æ–≤–æ
            await fetchPerformances();

            // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
            e.target.reset();
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–ø–µ–∫—Ç–∞–∫–ª—è:', err);
            document.getElementById('createResult').innerHTML = `
                <div class="alert alert-danger">
                    –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–ø–µ–∫—Ç–∞–∫–ª—è: ${err.message}
                </div>`;
        }
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    (async () => {
        await fetchGenres();
        await fetchPerformances();
    })();
</script>

<!-- Bootstrap 5 JS Bundle –∏–∑ CDN -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
