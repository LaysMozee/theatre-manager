<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>

    <meta charset="UTF-8" />
    <title>
        <span th:if="${worker.id == null}">Добавление сотрудника</span>
        <span th:if="${worker.id != null}">Редактирование сотрудника</span>
    </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        .photo-preview {
            max-width: 200px;
            max-height: 200px;
            object-fit: cover;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            box-shadow: 0 0 8px rgba(0,0,0,0.2);
        }
        #size-fields {
            animation: fadeIn 0.4s ease-in-out;
        }
        @keyframes fadeIn {
            from {opacity: 0; transform: translateY(-5px);}
            to {opacity: 1; transform: translateY(0);}
        }
                body {
        background-image: url('/uploads/photos/edit.png');
        background-size: cover;
        background-repeat: no-repeat;
        background-attachment: fixed;
    }
    </style>
</head>
<body>


<div class="container mt-5 mb-5">
    <div class="card shadow-lg">
        <div class="card-body p-4">
            <h3>
                <span th:if="${worker.id == null}">Добавить сотрудника</span>
                <span th:if="${worker.id != null}">Редактировать сотрудника</span>
            </h3>
            <form th:action="${formAction}" method="post" enctype="multipart/form-data" th:object="${worker}" class="needs-validation" novalidate>
                <input type="hidden" th:field="*{id}" />

                <div class="mb-3">
                    <label for="login" class="form-label">Логин</label>
                    <input type="text" th:field="*{login}" class="form-control" id="login" required />
                    <div class="invalid-feedback">Введите логин</div>
                </div>

                <div class="mb-3">
                    <label for="password" class="form-label">Пароль</label>
                    <input type="text" th:field="*{password}" class="form-control" id="password" required />
                    <div class="invalid-feedback">Введите пароль</div>
                </div>

                <div class="mb-3">
                    <label for="photoFile" class="form-label">Фото</label>
                    <input type="file" name="photoFile" class="form-control" id="photoFile" accept="image/*" onchange="previewPhoto(event)" />
                    <!-- Текущая фотка из БД -->
                    <img
                            id="currentPhoto"
                            th:if="${worker.photoFilename != null and worker.photoFilename != ''}"
                            th:src="@{'/uploads/photos/' + ${worker.photoFilename}}"
                            class="photo-preview mt-2"
                            alt="Текущая фотография сотрудника" />
                    <!-- Если нет фото из БД, покажем дефолт -->
                    <img
                            id="defaultPhoto"
                            th:if="${worker.photoFilename == null or worker.photoFilename == ''}"
                            th:src="@{/images/default-user.png}"
                            class="photo-preview mt-2"
                            alt="Фото по умолчанию" />
                    <!-- Превью загружаемой фотки, по умолчанию скрыто -->
                    <img id="preview" class="photo-preview mt-2 d-none" alt="Превью выбранной фотографии" />
                </div>

                <div class="mb-3">
                    <label for="fio" class="form-label">ФИО</label>
                    <input type="text" th:field="*{fio}" class="form-control" id="fio" required />
                    <div class="invalid-feedback">Введите ФИО</div>
                </div>

                <div class="mb-3">
                    <label for="age" class="form-label">Возраст</label>
                    <input type="number" th:field="*{age}" class="form-control" id="age" required />
                    <div class="invalid-feedback">Укажите возраст</div>
                </div>

                <div class="mb-3">
                    <label for="post" class="form-label">Должность</label>
                    <select th:field="*{post}" class="form-select" id="post" required>
                        <option value="">-- Выберите должность --</option>
                        <option value="Актёр">Актёр</option>
                        <option value="Режиссёр">Режиссёр</option>
                        <option value="Костюмер">Костюмер</option>
                        <option value="Персонал">Персонал</option>
                    </select>

                    <div class="invalid-feedback">Выберите должность</div>
                </div>

                <div id="size-fields" class="d-none">
                    <div class="mb-3">
                        <label for="shoeSize" class="form-label">Размер обуви</label>
                        <input type="number" th:field="*{shoeSize}" class="form-control" id="shoeSize" />
                    </div>
                    <div class="mb-3">
                        <label for="clothingSize" class="form-label">Размер одежды</label>
                        <input type="text" th:field="*{clothingSize}" class="form-control" id="clothingSize" />
                    </div>
                </div>

                <div class="mb-3">
                    <label for="experience" class="form-label">Опыт (лет)</label>
                    <input type="number" th:field="*{experience}" class="form-control" id="experience" required />
                    <div class="invalid-feedback">Укажите опыт</div>
                </div>

                <div class="d-flex justify-content-between">
                    <button type="submit" class="btn btn-primary px-4">Сохранить</button>
                    <a href="/workers" class="btn btn-outline-secondary">Отмена</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function toggleSizeFields() {
        const post = document.getElementById("post").value;
        const fields = document.getElementById("size-fields");
        fields.classList.toggle("d-none", post !== "Актёр");
    }

    function previewPhoto(event) {
        const input = event.target;
        const preview = document.getElementById("preview");
        const currentPhoto = document.getElementById("currentPhoto");
        const defaultPhoto = document.getElementById("defaultPhoto");
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.classList.remove("d-none");
                if(currentPhoto) currentPhoto.classList.add("d-none");
                if(defaultPhoto) defaultPhoto.classList.add("d-none");
            };
            reader.readAsDataURL(input.files[0]);
        } else {
            preview.classList.add("d-none");
            if(currentPhoto) currentPhoto.classList.remove("d-none");
            if(defaultPhoto) defaultPhoto.classList.remove("d-none");
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        toggleSizeFields();
        document.getElementById("post").addEventListener("change", toggleSizeFields);

        (() => {
            'use strict';
            const forms = document.querySelectorAll('.needs-validation');
            Array.from(forms).forEach(form => {
                form.addEventListener('submit', event => {
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        })();
    });
</script>
</body>
</html>
